### 필요한 개념
- 데이터베이스 구성 파일
	- 데이터 파일
    - 컨트롤 파일
    - REDO 로그 파일 
- SCN
- 체크포인트
- 인스턴스 복구(충돌 복구)
- 데이터베이스 기동
	- OPEN
    - MOUNT
    - NOMOUNT
    - SHUTDOWN
# 1. 백업
## 종류
- 물리 백업
	- 콜드 백업
	- 온라인 백업(=핫 백업)
- 논리 백업

### ① 콜드 백업
- 인스턴스를 완전히 정지한 상태에서 받는 백업
- 모든 데이터가 파일에 기록된 상태
### ② 온라인 백업
- 데이터베이스를 운영하는 상태에서 사용할 수 있는 백업
- 순서
	1. `ALTER TABLESPACE <테이블스페이스명> BEGIN BACKUP;` 
       `ALTER DATABASE BEGIN BACKUP;`
    2. 백업 실행
    3. `ALTER TABLESPACE <테이블스페이스명> END BACKUP;`
       `ALTER DATABASE BACKUP;`
- 유의사항
	- 운영 중에 백업을 받는 것이므로 체크포인트가 수행된 상태의 파일이 아님
    - 백업을 읽어오는 시점과 데이터를 변경하는 시점이 어긋나는 경우 제대로 읽는다는 보장이 없음
    - `BEGIN BACKUP` 부터 `END BACKUP`까지는 REDO 로그에 각종 정보를 추가해서 데이터를 복구할 수 있도록 동작
    - 따라서, 데이터 파일 복원한 후에는 반드시 REDO 로그를 적용해야 함
### ③ 논리 백업
- 데이터의 내용만을 빼내어 보존해두는 작업
- DUMP 파일,`EXPORT` 등을 사용
- REDO 로그를 통한 복구는 불가능 
- 배치 처리, DBA의 관리 작업 등 이전에 데이터를 보존하고 싶을 때 사용
- 혹은 운영상의 실수로 발생하는 사고에 대응할 때도 유효
	- 실수로 데이터를 삭제한 경우 등 
# 2. 데이터베이스 손상
- 디스크의 물리적 고장으로 인한 데이터 파일의 손상
	- RAID를 이용해 디스크를 다중화해두면 일정 부분 예방 가능
    - RAID 컨트롤러 고장, RAID 내부 데이터 유실 등 완전한 예방은 불가능
- OS 상에서의 삭제/덮어쓰기
	- 작업실수 등 
- 어떤 문제로 인한 블록 손상
	- 블록이 손상되더라도 오라클이 인식할 수 없는 경우가 있으며,
    - 다른 곳에도 손상된 블록이 존재할 수 있음
- 일시적인 데이터 파일의 접근 불가 
	- OS나 스토리지 측의 문제나 불안정한 상태 등
    - 읽어올 수 없다면 에러 발생
    - 기록할 수 없다면 데이터 파일을 오프라인으로 변경하고 복구가 필요하다고 인식
    - 만약 기록할 수 없는 테이블스페이스가 SYSTEM 테이블스페이스일 때는 인스턴스가 중지됨
- 하드웨어의 물리적인 고장이나 케이블의 문제
	- 디스크 이외의 하드웨어 고장, 케이블 문제로 인한 I/O 에러 등
    - 블록 손상이 발생하는 원인이 되기도 함
- 드라이버나 어댑터 카드 등의 제품 불안정에 의한 손상
# 3. 복구
- 가용성도 중요하지만,
- 복구에 걸리는 시간이나 재작업할 가능성이 낮아야 하는 것도 중요 
- 복구 제외 테이블 스페이스
	- 임시 테이블스페이스
    - 읽기 전용 테이블스페이스
    - 인덱스용 테이블스페이스
## 종류
- 인스턴스 복구 : 인스턴스가 비정상 종료된 후 다시 기동할 때 자동으로 수행되는 복구
- 미디어 복구 : 디스크의 데이터가 손상되었을 때 사용자가 명시적으로 수행하는 복구
<br>
- 완전 복구 : 데이터베이스를 최신 데이터까지 복구
- 불완전 복구 : 어떤 시점까지만 복구
<br>
- 데이터베이스 복구
- 테이블스페이스 복구
- 데이터파일 복구 
- 블록 복구 
### RMAN
- Recovery MANager
- 백업/복구를 간단하게 수행할 수 있는 관리 도구
- 오라클 8 이후 기본적으로 포함
<br>
**체인지 트래킹**
- 변경한 부분만을 백업하는 기능
- 변경된 부분만을 핀 포인트로 읽어 RMAN으로 백업 가능 
**증분 백업**
- 백업한 파일의 갱신 기능 
- 이전에 받은 풀 백업에 변경된 데이터를 적용 
- 체인지 트래킹과 함께 적용하면, 필요한 부분만을 읽어와서 풀 백업을 항상 최신 데이터로 유지할 수 있음
	- 단, 백업 자체를 갱신해야 하기 때문에 백업을 디스크에 보관해야만 한다는 제한이 존재 
## 흐름
### ① 데이터베이스가 손상되었는지를 확인
- 오라클은 가동 중인 상태 혹은 기동 전에 손상 여부 탐지 가능
- 사용자나 스토리지가 먼저 손상을 알아챌 수도 있음
- 오라클이 멈춘 경우 무엇이 망가졌는지를 조사해야 함 
	- 컨트롤 파일 손상
    - 초기화 파라미터 파일 손상
    - 데이터 파일 장애 
### ② 재작업할 수 있도록 현재 상태 백업
- 데이터베이스를 정지하고 현재의 상태를 백업
- 장애가 이중으로 발생하는 것을 막고, 다시 복구할 수 있는 방안을 마련
- 데이터 파일 뿐만 아니라, 컨트롤 파일이나 REDO로그 파일, 아카이브 REDO 로그 파일도 포함해서 백업 
### ③ 필요한 데이터 파일과 아카이브 REDO 로그 파일을 복원
- 실제로 데이터 파일이 손상되었거나 없어진 경우 복원이 필요 
- 복원한 파일의 시점이 장애 발생 이전인지 확인
- 복구 대상 데이터 파일이 누락되지 않았는지도 확인 
- 복구에 필요한 아카이브 REDO 로그 파일도 복원
### ④ 복구 실행 
1. 복구 프로세스가 아카이브 REDO 로그를 읽어서 어느 곳의 블록을 변경해야 하는지 파악
2. 블록이 캐시에 없다면 디스크에서 블록을 가져옴
3. 캐시에 있는 데이터를 변경 
=> DML문에 의한 데이터 변경 동작과 유사 
## 그 외의 복구
### 불완전 복구
- `recover DATABASE UNTIL XXX`로 복구
	- `TIME XXX`
    - `CANCEL`
    - `CHANGE XXX` 등의 옵션
- 대부분은 TIME을 사용해서 시간을 지정하거나 CANCEL을 지정
- RECOVER 명령이 끝나면, `ALTER DATABASE OPEN RESETLOGS` 입력
- `RESETLOGS`
	- 여러 정보를 초기화
    - 데이터 파일간의 시간이 맞지 않더라도 데이터베이스를 오픈할 수 있게 됨
    - REDO 로그를 청소하는 작업이 포함
    - 수행 시점 이전의 아카이브 REDO 로그는 OPEN 후 더 이상 사용 불가 
### 테이블스페이스 복구
- MOUNT 상태에서 해당 테이블스페이스 혹은 데이터 파일을 오프라인으로 변경
	- `ALTER DATABASE DATAFILE <데이터 파일> OFFLINE`
    - `ALTER TABLESPACE <테이블스페이스명> OFFLINE`
- 이후 OPEN 명령어를 실행해도, OFFLINE으로 전환한 파일 안의 데이터는 사용 불가
- 필요한 파일을 복원해서 복구 수행
- 복구가 끝나면 사용할 수 있는 상태로 변환
	- `ALTER DATABASE DATAFILE <데이터 파일> ONLINE`
    - `ALTER TABLESPACE <테이블 스페이스명> ONLINE`
### 컨트롤파일 복구
- 일반적으로 다중화되어 있으므로, 일부 손상은 덮어쓰기로 해결 가능 
	- alter.log를 확인해서 손상된 파일을 초기화 파라미터의 컨트롤 파일 목록에서 제외 
	- 기동할 때 정상적으로 사용할 수 있었던 컨트롤 파일을 사용해서 문제 발생 파일 덮어쓰기
- 전체 파일이 손상된 경우, 컨트롤 파일을 다시 생성하거나 컨트롤 파일의 백업을 복원 